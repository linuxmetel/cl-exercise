<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>{{ question.data.name }} - Lisp Tutor</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="/static/HttpRequest.js"></script>
  <script src="/static/EvalClient.js"></script>
  <script>
    const QUESTION_PATH = "{{ question.path }}";
    const QUESTION = {
      prepare: "{{ question.data.prepare | safe }}" || null,
      test: {% if question.data.test %} "{{ question.data.test | safe }}" {% else %} null {% endif %},
      expect: {% if question.data.expect %} "{{ question.data.expect | safe }}" {% else %} null {% endif %},
      requirements: {
        symbols: {% if question.data.requirements.symbols %} "{{ question.data.requirements.symbols | safe }}" {% else %} null {% endif %}
      }
    };
    let client = new EvalClient("{{ host }}", "user_id", "tutor");
    function send(code, resultElement, callback) {
      client.initialize(["cl-exercise"])
        .then(() => {
          client.eval(QUESTION.prepare)
           .then(() => {
             const options = {
               test: QUESTION.test,
               expect: QUESTION.expect,
               requirements: QUESTION.requirements
             };
             client.eval(code, null, null, options)
               .then(res => {
                 callback();
                 let result = res.result;
                 console.log(res);
                 resultElement.innerHTML = `<p>${result.returnValue}</p><pre>${result.output}</pre>`;
               })
               .catch(err => {
                 callback();
                 console.log(err);
               })
            })
           .catch(() => {
             callback();
             console.error("Error has thrown when preparing the question.");
           })
        })
    }
    function onclickEvalButton() {
      let editor = document.getElementById("editor");
      let result = document.getElementById("result");
      let loader = document.getElementById("eval-loader");
      result.innerHTML = "";
      loader.classList.add("show");
      send(editor.innerHTML, result, () => loader.classList.remove("show"));
    }
  </script>
</head>
<body>
  <header>
    <h1>Lisp Tutor</h1>
  </header>
  <section class="center">
    <div id="desc-area" class="block">
      <h2>{{ question.data.name }}</h2>
      <pre>{{ question.data.content }}</pre>
    </div>
    <div id="edit-area" class="block">
      <div id="editor" contenteditable="true" spellcheck="false"></div>
    </div>
    <input id="eval-button" type="button" value="Check" onclick="onclickEvalButton();">
    <div id="result-area" class="block">
      <div id="eval-loader" class="loader center"><span>(</span><span>)</span></div>
      <div id="result"></div>
    </div>
  </section>
</body>
</html>
